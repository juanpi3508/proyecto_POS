# ============================================
# Mapeo de tabla COMPRAS
# ============================================
comp.1=id_compra
comp.2=id_proveedor
comp.3=oc_fecha_hora
comp.4=oc_subtotal
comp.5=oc_iva
comp.6=oc_total
comp.7=estado_oc

# ============================================
# Mapeo de tabla PROxOC
# ============================================
pxo.1=id_compra
pxo.2=id_producto
pxo.3=pxo_cantidad
pxo.4=pxo_precio_compra
pxo.5=pxo_subtotal_producto
pxo.6=estado_pxo

comp.iva=0.15
comp.estado=ABI
# ============================================
# **COMPRAS**
# ============================================

# Insertar Orden de Compra
comp.insertar=INSERT INTO compras (id_compra, id_proveedor, oc_fecha_hora, oc_subtotal, oc_iva, oc_total, estado_oc) VALUES (?, ?, ?, ?, ?, ?, ?)

# Modificar totales de la OC
comp.modificar=UPDATE compras SET oc_subtotal=?, oc_iva=?, oc_total=? WHERE id_compra=?

# Eliminar (anular) OC
comp.eliminar=UPDATE compras SET estado_oc='ANU' WHERE id_compra=?

# Consultar todas las OC aprobadas
comp.consultar.todos=SELECT id_compra, id_proveedor, oc_fecha_hora, oc_subtotal, oc_iva, oc_total, estado_oc FROM compras WHERE estado_oc='APR' ORDER BY oc_fecha_hora DESC

# Consultar OC por proveedor (ABI)
comp.consultar.porProveedor=SELECT c.id_compra, c.id_proveedor, c.oc_fecha_hora, c.oc_subtotal, c.oc_iva, c.oc_total, c.estado_oc FROM compras c INNER JOIN proveedores p ON c.id_proveedor = p.id_proveedor WHERE p.prv_ruc_ced=? AND c.estado_oc='ABI' ORDER BY c.oc_fecha_hora DESC

# Consultar por código de compra (para modificar)
comp.consultar.porCodigo=SELECT id_compra, id_proveedor, oc_fecha_hora, oc_subtotal, oc_iva, oc_total, estado_oc FROM compras WHERE id_compra=?

# Consultar por proveedor (todas: APR y ANU)
comp.consultar.porProveedor.todas=SELECT c.id_compra, c.id_proveedor, c.oc_fecha_hora, c.oc_subtotal, c.oc_iva, c.oc_total, c.estado_oc FROM compras c INNER JOIN proveedores p ON c.id_proveedor = p.id_proveedor WHERE p.prv_ruc_ced=? ORDER BY c.oc_fecha_hora DESC

# Consultar por código (sin filtro de estado ? para detalle)
comp.consultar.porCodigo.detalle=SELECT id_compra, id_proveedor, oc_fecha_hora, oc_subtotal, oc_iva, oc_total, estado_oc FROM compras WHERE id_compra=?

# Procedure Aprobar Orden de Compra
comp.aprobar=SELECT (fn_aprobar_compra_json(?) ->> 'ok')::boolean;


# ============================================
# **PROxOC**
# ============================================

# Insertar / actualizar detalle de OC
pxo.insertar=INSERT INTO proxoc (id_compra, id_producto, pxo_cantidad, pxo_precio_compra, pxo_subtotal_producto, estado_pxo) VALUES (?, ?, ?, ?, ?, 'ABI') ON CONFLICT (id_compra, id_producto) DO UPDATE SET pxo_cantidad = EXCLUDED.pxo_cantidad, pxo_precio_compra = EXCLUDED.pxo_precio_compra, pxo_subtotal_producto = EXCLUDED.pxo_subtotal_producto, estado_pxo='ABI';

# Modificar detalle
pxo.actualizar=UPDATE proxoc SET pxo_cantidad=?, pxo_precio_compra=?, pxo_subtotal_producto=?, estado_pxo='ABI' WHERE id_compra=? AND id_producto=?;

# Eliminar todos los productos de una OC
pxo.eliminar.porCompra=UPDATE proxoc SET estado_pxo='ANU' WHERE id_compra=?

# Eliminar un producto específico
pxo.eliminar.porProducto=DELETE FROM proxoc WHERE id_compra=? AND id_producto=?

# Consultar detalle por compra (todos)
pxo.consultar.porCompra=SELECT id_compra, id_producto, pxo_cantidad, pxo_precio_compra, pxo_subtotal_producto, estado_pxo FROM proxoc WHERE id_compra=?

# Consultar detalle por compra (solo ABI)
pxo.consultar.porCompra.ABI=SELECT id_compra, id_producto, pxo_cantidad, pxo_precio_compra, pxo_subtotal_producto, estado_pxo FROM proxoc WHERE id_compra=? AND estado_pxo='ABI'

# Verificar existencia producto en OC
pxo.verificar=SELECT * FROM proxoc WHERE id_compra=? AND id_producto=?
